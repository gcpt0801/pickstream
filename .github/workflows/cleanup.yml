name: Cleanup Old Images

on:
  workflow_dispatch:

jobs:
  cleanup-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Delete old images
      run: |
        # Keep only the 3 most recent images
        gcloud compute images list \
          --filter="family:pickstream" \
          --sort-by=~creationTimestamp \
          --format="value(name)" \
          | tail -n +4 \
          | xargs -r -I {} gcloud compute images delete {} --quiet
          
    - name: List remaining images
      run: |
        echo "Remaining images:"
        gcloud compute images list --filter="family:pickstream"
