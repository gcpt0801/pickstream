name: Build and Deploy to GCP

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_packer:
        description: 'Skip Packer image build (use existing image)'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main

jobs:
  build-deploy:
    name: Maven â†’ Packer â†’ Terraform
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'production' }}
    
    steps:
    # ===== MAVEN BUILD =====
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ðŸ”¨ Maven Build
      run: |
        echo "========================================="
        echo "Step 1/3: Building with Maven"
        echo "========================================="
        mvn clean package
        ls -lh target/random-names.war
      
    - name: ðŸ“¦ Upload WAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: webapp-war-${{ github.sha }}
        path: target/random-names.war
        retention-days: 7
    
    # ===== GCP AUTHENTICATION =====
    - name: ðŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: â˜ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    # ===== PACKER BUILD =====
    - name: ðŸ“¦ Setup Packer
      if: ${{ !inputs.skip_packer }}
      uses: hashicorp/setup-packer@v3
      with:
        version: 'latest'
        
    - name: ðŸ”§ Packer Init
      if: ${{ !inputs.skip_packer }}
      working-directory: ./packer
      run: packer init image.pkr.hcl
      
    - name: âœ… Packer Validate
      if: ${{ !inputs.skip_packer }}
      working-directory: ./packer
      run: |
        packer validate \
          -var-file="variables.pkrvars.hcl" \
          image.pkr.hcl
          
    - name: ðŸ—ï¸ Packer Build
      if: ${{ !inputs.skip_packer }}
      working-directory: ./packer
      run: |
        echo "========================================="
        echo "Step 2/3: Building Packer Image"
        echo "========================================="
        packer build \
          -var-file="variables.pkrvars.hcl" \
          image.pkr.hcl
    
    - name: â­ï¸ Skip Packer Build
      if: ${{ inputs.skip_packer }}
      run: |
        echo "========================================="
        echo "Skipping Packer image build - using existing image"
        echo "========================================="
          
    # ===== TERRAFORM DEPLOY =====
    - name: ðŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 'latest'
        terraform_wrapper: false
        
    - name: ðŸ”§ Terraform Init
      working-directory: ./terraform
      run: terraform init
      
    - name: âœ… Terraform Validate
      working-directory: ./terraform
      run: terraform validate
      
    - name: ðŸ“‹ Terraform Plan
      working-directory: ./terraform
      run: |
        echo "========================================="
        echo "Step 3/3: Planning Terraform Deployment"
        echo "========================================="
        terraform plan \
          -var-file="terraform.tfvars" \
          -out=tfplan
          
    - name: ðŸ—‘ï¸ Terraform Destroy (if exists)
      working-directory: ./terraform
      run: |
        echo "Checking for existing resources..."
        terraform destroy -var-file="terraform.tfvars" -auto-approve || echo "No resources to destroy"
        
    - name: ðŸ“‹ Terraform Re-Plan (after destroy)
      working-directory: ./terraform
      run: |
        echo "Re-planning after destroy..."
        terraform plan \
          -var-file="terraform.tfvars" \
          -out=tfplan-fresh
        
    - name: ðŸš€ Terraform Apply
      working-directory: ./terraform
      run: |
        echo "========================================="
        echo "Applying Terraform Configuration"
        echo "========================================="
        terraform apply -auto-approve tfplan-fresh
      
    - name: ðŸ“Š Deployment Summary
      working-directory: ./terraform
      run: |
        echo "========================================="
        echo "ðŸŽ‰ Deployment Completed Successfully!"
        echo "========================================="
        echo ""
        terraform output
        echo ""
        APP_URL=$(terraform output -raw webapp_url 2>/dev/null || echo "Not available")
        EXTERNAL_IP=$(terraform output -raw instance_external_ip 2>/dev/null || echo "Not available")
        echo "ðŸŒ Application URL: $APP_URL"
        echo "ðŸ“ External IP: $EXTERNAL_IP"
        echo "APP_URL=$APP_URL" >> $GITHUB_ENV
        echo "EXTERNAL_IP=$EXTERNAL_IP" >> $GITHUB_ENV
        
    - name: ðŸ’¬ Create deployment summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY <<EOF
        # ðŸš€ Deployment Complete
        
        ## ðŸ“¦ Build Information
        - **Commit**: \`${{ github.sha }}\`
        - **Branch**: \`${{ github.ref_name }}\`
        - **Environment**: ${{ inputs.environment || 'production' }}
        
        ## ðŸŒ Access Information
        - **Application URL**: ${{ env.APP_URL }}
        - **External IP**: ${{ env.EXTERNAL_IP }}
        
        ## âœ… Deployment Steps
        1. âœ… Maven build completed
        2. ${{ inputs.skip_packer && 'â­ï¸ Packer build skipped' || 'âœ… Packer image built' }}
        3. âœ… Terraform deployed successfully
        
        ---
        **Deployed at**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        EOF
