name: PR Checks

on:
  workflow_dispatch:

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Build and compile
      run: mvn clean compile
      
    - name: Run tests
      run: mvn test
      
    - name: Check code formatting
      run: mvn validate
      continue-on-error: true

  terraform-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      
    - name: Terraform Format Check
      working-directory: ./terraform
      run: terraform fmt -check -recursive
      continue-on-error: true
      
    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init -backend=false
      
    - name: Terraform Validate
      working-directory: ./terraform
      run: terraform validate

  packer-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Packer
      uses: hashicorp/setup-packer@v3
      
    - name: Packer Format Check
      working-directory: ./packer
      run: packer fmt -check image.pkr.hcl
      continue-on-error: true
      
    - name: Packer Init
      working-directory: ./packer
      run: packer init image.pkr.hcl
      
    - name: Packer Validate
      working-directory: ./packer
      run: |
        packer validate \
          -var "project_id=dummy-project" \
          -var "zone=us-central1-a" \
          image.pkr.hcl
