name: Destroy GCP Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "destroy" to confirm destruction of all resources'
        required: true
        type: string

jobs:
  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âœ… Verify Confirmation
      run: |
        if [ "${{ inputs.confirmation }}" != "destroy" ]; then
          echo "âŒ Confirmation failed. You must type 'destroy' to proceed."
          exit 1
        fi
        echo "âœ… Confirmation received. Proceeding with destruction..."
    
    - name: ðŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: â˜ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
        
    - name: ðŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 'latest'
        terraform_wrapper: false
        
    - name: ðŸ”§ Terraform Init
      working-directory: ./terraform
      run: terraform init -reconfigure
      
    - name: ðŸ“‹ Show Resources to be Destroyed
      working-directory: ./terraform
      run: |
        echo "========================================="
        echo "Resources that will be destroyed:"
        echo "========================================="
        terraform show
        echo ""
        echo "========================================="
        terraform state list || echo "No resources in state"
        
    - name: ðŸ—‘ï¸ Terraform Destroy
      working-directory: ./terraform
      run: |
        echo "========================================="
        echo "ðŸ—‘ï¸  Destroying all infrastructure..."
        echo "========================================="
        terraform destroy -var-file="terraform.tfvars" -auto-approve
        
    - name: ðŸ§¹ Force Cleanup Orphaned Resources
      run: |
        echo "========================================="
        echo "Cleaning up any orphaned resources..."
        echo "========================================="
        
        # Delete compute instance
        gcloud compute instances delete pickstream-instance \
          --project=gcp-terraform-demo-474514 \
          --zone=us-central1-a \
          --quiet 2>/dev/null || echo "âœ“ Instance already deleted"
        
        # Delete firewall rules
        gcloud compute firewall-rules delete allow-ssh \
          --project=gcp-terraform-demo-474514 \
          --quiet 2>/dev/null || echo "âœ“ SSH firewall already deleted"
        
        gcloud compute firewall-rules delete allow-http \
          --project=gcp-terraform-demo-474514 \
          --quiet 2>/dev/null || echo "âœ“ HTTP firewall already deleted"
        
        gcloud compute firewall-rules delete allow-tomcat \
          --project=gcp-terraform-demo-474514 \
          --quiet 2>/dev/null || echo "âœ“ Tomcat firewall already deleted"
        
        # Delete static IP
        gcloud compute addresses delete pickstream-instance-static-ip \
          --project=gcp-terraform-demo-474514 \
          --region=us-central1 \
          --quiet 2>/dev/null || echo "âœ“ Static IP already deleted"
        
        # Delete subnets in the network
        gcloud compute networks subnets delete webapp-network \
          --project=gcp-terraform-demo-474514 \
          --region=us-central1 \
          --quiet 2>/dev/null || echo "âœ“ Subnet already deleted"
        
        # Delete VPC network (must be last)
        gcloud compute networks delete webapp-network \
          --project=gcp-terraform-demo-474514 \
          --quiet 2>/dev/null || echo "âœ“ Network already deleted"
        
        echo "âœ… All resources cleaned up!"
        
    - name: ðŸ§¹ Delete Packer Images (optional)
      run: |
        echo "========================================="
        echo "Checking for Packer images to delete..."
        echo "========================================="
        gcloud compute images list --filter="family:pickstream" --format="table(name,creationTimestamp)" || true
        echo ""
        echo "To delete images manually, run:"
        echo "gcloud compute images delete IMAGE_NAME --project=gcp-terraform-demo-474514"
        
    - name: âœ… Destruction Complete
      run: |
        echo "========================================="
        echo "ðŸŽ‰ Infrastructure destroyed successfully!"
        echo "========================================="
        echo ""
        echo "All Terraform-managed resources have been removed."
        echo "Note: Packer images are retained. Delete manually if needed."
        
    - name: ðŸ’¬ Create destruction summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY <<EOF
        # ðŸ—‘ï¸ Infrastructure Destroyed
        
        ## âœ… Destruction Details
        - **Triggered by**: @${{ github.actor }}
        - **Commit**: \`${{ github.sha }}\`
        - **Branch**: \`${{ github.ref_name }}\`
        
        ## ðŸ§¹ Resources Removed
        - Compute Instance
        - Static IP Address
        - Firewall Rules
        - VPC Network
        
        ## ðŸ“ Notes
        - Terraform state remains in GCS bucket \`gcp-tftbk\`
        - Packer images are retained (delete manually if needed)
        - You can redeploy by running the "Build and Deploy to GCP" workflow
        
        ---
        **Destroyed at**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        EOF
